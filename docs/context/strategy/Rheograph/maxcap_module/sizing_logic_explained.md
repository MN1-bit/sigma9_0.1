# 최대 사이징 로직: 쉬운 설명

> 이 문서는 `sizing_logic_discussion.md`의 최종 합의 알고리즘을 **프로그래밍 지식 없이도 이해할 수 있도록** 풀어서 설명합니다.

---

## 이 로직이 하는 일

**"한 번의 거래에서 최대 몇 주까지 사도 되는가?"** 를 계산합니다.

너무 많이 사면:
- 내 주문이 가격을 밀어올림 (불리한 가격에 체결)
- 급하게 팔아야 할 때 못 팔 수 있음

그래서 **"가격에 영향을 주지 않는 최대 수량"**을 계산합니다.

---

## 설정 파라미터 (미리 정해두는 숫자들)

### 시간 관련

| 이름 | 값 | 의미 |
|------|-----|------|
| TAU_IN | 4초 | 들어갈 때 이 시간 안에 전부 체결되어야 함 |
| TAU_OUT | 2초 | 나갈 때 이 시간 안에 전부 체결되어야 함 (더 짧음) |

**왜 나갈 때가 더 짧은가?**
- 주가가 급락할 때 빨리 나가야 하니까
- 다른 사람들도 동시에 나가려고 하니까

---

### 슬리피지 예산

| 이름 | 값 | 의미 |
|------|-----|------|
| B_IN_BPS | 12 | 들어갈 때 0.12%까지 손해 허용 |
| B_OUT_BPS | 10 | 나갈 때 0.10%까지 손해 허용 |

**bps가 뭔가요?**
- bps = "basis point" = 0.01%
- 12 bps = 0.12%
- $10,000 투자하면 $12 손해까지 허용한다는 뜻

---

### 마찰 계수

| 이름 | 값 | 의미 |
|------|-----|------|
| KAPPA_FLOOR_BPS | 100 | 마찰 최소값 (1%) |
| K_SPR | 4 | 스프레드에 곱하는 배수 |

**마찰이 뭔가요?**
- 주식 시장에서 거래할 때 발생하는 저항
- 스프레드(매수-매도 가격 차이)가 넓으면 마찰이 큼
- 마찰이 클수록 살 수 있는 양이 줄어듦

**계산법:**
```
마찰 = max(100, 4 × 스프레드)
```
- 스프레드가 10 bps면: max(100, 40) = 100
- 스프레드가 50 bps면: max(100, 200) = 200

---

### 패닉 할인

| 이름 | 값 | 의미 |
|------|-----|------|
| PANIC_DISCOUNT | 0.4 | 급락 시 유동성이 60% 줄어든다고 가정 |

**왜 이게 필요한가?**
- 평소에 1초에 $1,000어치 거래되는 주식이 있다고 가정
- 급락이 오면 모두 팔려고만 함
- 실제로 팔 수 있는 양은 $400어치밖에 안 됨
- 그래서 0.4를 곱함 (40%만 남는다고 가정)

---

### 차단 조건 (이러면 거래 안 함)

| 이름 | 값 | 의미 |
|------|-----|------|
| SPREAD_HARD_MAX_BPS | 200 | 스프레드가 2% 넘으면 거래 금지 |
| L_MIN_DOLLAR_PER_SEC | 100 | 1초에 $100도 안 거래되면 거래 금지 |
| Q_MIN_SHARES | 100 | 최소 100주는 사야 의미 있음 |
| NOTIONAL_MIN | 500 | 최소 $500은 사야 의미 있음 |

**왜 이런 조건이 필요한가?**
- 스프레드가 너무 넓으면 손해가 큼
- 거래량이 너무 적으면 팔 때 못 팔 수 있음
- 너무 적은 수량은 수수료만 나감

---

### 플로트 캡

| 이름 | 값 | 의미 |
|------|-----|------|
| PHI | 0.002 | 유통 주식의 0.2% 이상은 사지 않음 |

**플로트가 뭔가요?**
- 시장에서 실제로 거래 가능한 주식 수
- 예: 회사가 1억 주 발행했는데, 경영진이 7천만 주 보유
- 플로트 = 3천만 주

**왜 제한하는가?**
- 내가 플로트의 1%를 가지면, 팔 때 내가 가격을 좌우하게 됨
- 그러면 "가격에 영향 없음" 조건을 만족 못 함

---

### 시간대 배수

| 시간대 | 이름 | 배수 | 의미 |
|--------|------|------|------|
| 장 전 | PRE | 0.3 | 유동성 적음, 30%만 |
| 개장 직후 | OPN | 1.3 | 유동성 폭발, 130% |
| 오전 중반 | MID1 | 1.0 | 기준값 |
| 점심 시간대 | DEAD | 0.5 | 유동성 적음, 50%만 |
| 오후 중반 | MID2 | 0.8 | 조금 적음 |
| 장 마감 전 | CLO | 1.2 | 유동성 증가 |
| 장 마감 후 | AH | 0.2 | 거의 없음 |

**왜 시간대별로 다른가?**
- 장 시작 30분은 거래가 폭발함 → 더 살 수 있음
- 점심 시간은 거래가 뜸함 → 덜 사야 함

---

## 알고리즘 (단계별 설명)

### 입력으로 받는 정보

1. **bid**: 현재 매수 호가 (가장 높은 사겠다는 가격)
2. **ask**: 현재 매도 호가 (가장 낮은 팔겠다는 가격)
3. **mid**: (bid + ask) / 2
4. **last_price**: 마지막 체결 가격
5. **last_size**: 마지막 체결 수량 (주)
6. **dt**: 마지막 체결로부터 지난 시간 (초)
7. **L_prev**: 이전에 계산해둔 유동성 속도 ($/초)
8. **Float**: 이 종목의 유통 주식 수
9. **tod**: 현재 시간대 코드 (OPN, DEAD 등)

---

### 단계 1: 스프레드 계산

```
spread_bps = (ask - bid) / mid × 10,000
```

**예시:**
- bid = $10.00, ask = $10.05, mid = $10.025
- spread_bps = 0.05 / 10.025 × 10,000 = 49.88 bps

**의미:**
- 매수-매도 가격 차이가 전체 가격의 몇 %인지 계산
- 이 값이 크면 거래 비용이 비싸다는 뜻

---

### 단계 2: 유동성 속도(L) 업데이트

```
trade_notional = last_price × last_size
rate = trade_notional / dt
L = 새로운 값과 이전 값의 가중 평균 (EMA)
```

**예시:**
- 마지막 거래: 500주 × $10 = $5,000
- 0.5초 전에 체결됨
- rate = $5,000 / 0.5초 = $10,000/초

**EMA(지수평활평균)란?**
- 최근 값에 더 큰 가중치를 주는 평균
- 갑자기 값이 튀어도 너무 급격히 변하지 않음
- 5초 정도의 반감기 사용

**의미:**
- "이 종목이 지금 1초에 얼마나 거래되고 있는가"를 추정
- L = $5,000/초면, 1초에 평균 $5,000어치 거래됨

---

### 단계 3: 차단 조건 확인

```
만약 spread_bps > 200 이면 → 거래 금지 (0 반환)
만약 L < 100 이면 → 거래 금지 (0 반환)
```

**의미:**
- 스프레드가 2% 넘으면: 거래 비용이 너무 비쌈
- 1초에 $100도 안 거래되면: 유동성이 너무 없음

**여기서 걸리면 이후 계산을 하지 않고 바로 "0주"를 반환**

---

### 단계 4: 마찰 계수 계산

```
kappa = max(100, 4 × spread_bps)
```

**예시:**
- spread_bps = 50
- kappa = max(100, 200) = 200

**의미:**
- 스프레드가 넓을수록 마찰이 큼
- 마찰이 크면 살 수 있는 양이 줄어듦

---

### 단계 5: 시간대 배수 가져오기

```
tod_mult = 시간대에 해당하는 배수
```

**예시:**
- 현재 시간이 9:45 (개장 직후) → tod = "OPN" → tod_mult = 1.3
- 현재 시간이 12:30 (점심) → tod = "DEAD" → tod_mult = 0.5

---

### 단계 6: 예상 거래량 계산

**진입할 때 예상 거래량:**
```
V_in = L × TAU_IN × tod_mult
```

**청산할 때 예상 거래량 (더 보수적):**
```
V_out = L × TAU_OUT × PANIC_DISCOUNT × tod_mult
```

**예시 (L = $5,000/초, tod_mult = 1.0):**
- V_in = 5,000 × 4 × 1.0 = $20,000
- V_out = 5,000 × 2 × 0.4 × 1.0 = $4,000

**의미:**
- "진입할 때 4초 동안 시장에서 약 $20,000어치 거래될 것"
- "급하게 나갈 때 2초 동안 실제로 $4,000어치만 거래될 것"

---

### 단계 7: 최대 주문 금액 계산

**핵심 공식:**
```
Q_in = V_in × (B_IN_BPS / kappa)²
Q_out = V_out × (B_OUT_BPS / kappa)²
```

**예시 (V_in = $20,000, V_out = $4,000, kappa = 200):**
- Q_in = 20,000 × (12 / 200)² = 20,000 × 0.0036 = $72
- Q_out = 4,000 × (10 / 200)² = 4,000 × 0.0025 = $10

**왜 제곱인가?**
- 시장 임팩트 이론에서 나온 공식
- 마찰이 2배 커지면 살 수 있는 양은 4배 줄어듦

**의미:**
- 들어갈 때 최대 $72까지 슬리피지 12 bps 이내로 살 수 있음
- 나갈 때 최대 $10까지 슬리피지 10 bps 이내로 팔 수 있음

---

### 단계 8: 플로트 캡 계산

```
Q_float_cap = PHI × Float × last_price
```

**예시 (Float = 100만 주, last_price = $10):**
- Q_float_cap = 0.002 × 1,000,000 × 10 = $20,000

**의미:**
- 유통 주식의 0.2% × 가격 = 최대 투입 가능 금액

---

### 단계 9: 세 가지 중 최소값 선택

```
Q_max_notional = min(Q_in, Q_out, Q_float_cap)
```

**예시:**
- Q_in = $72
- Q_out = $10
- Q_float_cap = $20,000
- Q_max_notional = min(72, 10, 20000) = **$10**

**주수로 변환:**
```
Q_max_shares = Q_max_notional / last_price = 10 / 10 = 1주
```

**왜 최소값인가?**
- 세 조건을 모두 만족해야 안전함
- 하나라도 위반하면 문제가 생길 수 있음

---

### 단계 10: 최소 사이즈 확인

```
만약 Q_max_shares < 100 이면 → 거래 금지 (0 반환)
만약 Q_max_notional < $500 이면 → 거래 금지 (0 반환)
```

**예시에서:**
- Q_max_shares = 1주 < 100주 → **거래 금지, 0 반환**

**의미:**
- 계산 결과가 너무 작으면 거래할 가치가 없음
- 수수료만 나가기 때문

---

### 최종 출력

- **0**: 거래하지 마라
- **정수 (예: 500)**: 최대 500주까지 사도 됨

---

## 전체 흐름 요약

```
1. 스프레드 계산
2. 유동성 속도(L) 업데이트
3. 차단 조건 확인 (스프레드 너무 큼? 거래량 너무 적음?)
   → 걸리면 0 반환
4. 마찰 계수(kappa) 계산
5. 시간대 배수 가져오기
6. 진입/청산 시 예상 거래량 계산
7. 진입/청산 시 최대 주문 금액 계산
8. 플로트 캡 계산
9. 세 값 중 최소 선택
10. 너무 작으면 0, 아니면 주수로 반환
```

---

## 숫자 예시 (전체 과정)

**상황:**
- AAPL 주식, 가격 $150
- bid = $149.95, ask = $150.05
- 마지막 거래: 200주, 0.2초 전
- 유통 주식 = 1600만 주
- 시간: 10:30 (MID1)
- 이전 L = $50,000/초

**계산:**

1. spread_bps = (150.05 - 149.95) / 150 × 10,000 = **6.67 bps**
2. trade_notional = 150 × 200 = $30,000
   rate = 30,000 / 0.2 = $150,000/초
   L = 0.04 × 150,000 + 0.96 × 50,000 = **$54,000/초** (대략)
3. 차단 조건: 6.67 < 200 ✓, 54,000 > 100 ✓ → 통과
4. kappa = max(100, 4 × 6.67) = max(100, 26.7) = **100**
5. tod_mult = 1.0 (MID1)
6. V_in = 54,000 × 4 × 1.0 = **$216,000**
   V_out = 54,000 × 2 × 0.4 × 1.0 = **$43,200**
7. Q_in = 216,000 × (12/100)² = 216,000 × 0.0144 = **$3,110**
   Q_out = 43,200 × (10/100)² = 43,200 × 0.01 = **$432**
8. Q_float_cap = 0.002 × 16,000,000 × 150 = **$4,800,000**
9. Q_max_notional = min(3110, 432, 4800000) = **$432**
   Q_max_shares = 432 / 150 = **2.88주 → 2주**
10. 2주 < 100주 → **거래 금지, 0 반환**

**결과:** 이 상황에서는 거래하지 않음 (계산된 양이 너무 적음)

---

## 왜 이렇게 설계했는가?

1. **청산이 진입보다 항상 빡빡함**
   - PANIC_DISCOUNT (0.4)가 청산에만 적용
   - TAU_OUT (2초)가 TAU_IN (4초)보다 짧음
   - 이유: 팔 때가 더 어렵기 때문

2. **마찰이 크면 급격히 양이 줄어듦**
   - 제곱 관계이므로 마찰 2배 → 양 4배 감소
   - 이유: 시장 임팩트 이론에서 증명된 관계

3. **여러 조건 중 가장 엄격한 것을 따름**
   - min(Q_in, Q_out, Q_float_cap)
   - 이유: 하나라도 위반하면 문제가 생김

4. **차단 조건이 먼저 확인됨**
   - 복잡한 계산 전에 기본 조건부터 확인
   - 이유: 연산 절약 + 명백한 위험 조기 차단

---

*문서 끝*
