# Pre-Surge Detection 전략: ML 전문가 기술 리뷰 요청

> **문서 번호**: 002-03  
> **작성일**: 2026-01-15  
> **목적**: 현재 개발 방향에 대한 ML 전문가의 자유로운 검토 및 피드백 요청

---

## Executive Summary

미국 주식시장에서 **당일 +75% 이상 급등하는 종목(Daygainer)**을 급등 이전 시점에 탐지하는 **Scanner Filter**를 개발 중입니다. 이 문서는 현재까지의 설계 결정과 구현 방향을 정리한 것으로, ML 전문가의 자유로운 검토와 피드백을 요청드립니다.

---

## 1. 프로젝트 목표

### 1.1 핵심 질문

> **"급등 전날/직전에 해당 종목을 미리 스캔할 수 있는가?"**

### 1.2 최종 출력물

분류 모델 자체가 아닌, **해석 가능한 Scanner Filter 룰**을 도출하는 것이 목표입니다.

```
예시 출력:
IF (tight_range_intensity > 0.7 AND 
    premarket_rvol > 3.0 AND 
    price_vs_20d_low < -15%)
THEN → 워치리스트 추가
```

### 1.3 운용 컨텍스트

```
[D-1 스캐너] → 100~200개 후보 → [M-n 실시간 경보] → 트레이더 최종 판단 → 진입
```

- 스캐너가 걸러낸 종목을 트레이더가 추가 판단
- **Recall 우선**: 급등주를 놓치는 것보다 False Positive가 낫다는 판단
- 목표 Recall: **> 70%**

---

## 2. 데이터셋 설계

### 2.1 Daygainer 정의

| 기준 | 값 | 근거 |
|------|-----|------|
| 등락률 | ≥ +75% (시가→종가) | 극단적 급등만 포착 |
| 거래대금 | ≥ $50만 | 유동성 확보 |
| 가격 | ≥ $0.1 | 초저가주 제외 |

### 2.2 데이터 규모

| 구분 | 기간 | 레코드 수 |
|------|------|----------|
| **Daygainer** (양성) | 2021~2026 (5년) | 1,284건 |
| **Control Group** (음성) | 동일 기간 | 4,205건 |
| **총 샘플** | - | **~5,500건** |

### 2.3 대조군 매칭 로직

대조군은 단순히 "급등하지 않은 종목"이 아니라, **급등할 뻔했으나 실패한 종목**을 포함하도록 설계:

| 조건 | 값 | 근거 |
|------|-----|------|
| 동일 날짜 | 필수 | 시장 환경 통제 |
| 종가 등락률 | -50% ~ +10% | 급등 미발생 |
| **RVOL 스파이크** | 분봉 RVOL ≥ 2x 존재 | 시장 관심 받은 종목만 포함 |
| 가격 구간 매칭 | Tier 기반 | 가격대 유사성 확보 |
| 매칭 비율 | 1:5 (Daygainer:Control) | - |

**Failed Pump 별도 라벨링**:
- 조건: RVOL 스파이크 발생 + HOD 대비 30% 하락
- 용도: 급등 실패 패턴 분석

---

## 3. 피처 아키텍처

### 3.1 2-Tier 시스템

| Tier | 용도 | 시점 | 피처 수 |
|------|------|------|---------|
| **D-1** | 장전 유니버스 필터 | 전일 종가 기준 | ~150개 |
| **M-n** | 장중 실시간 경보 | T0 직전 n분 | ~100개 |
| **기타** | 프리마켓 + 메타 | - | ~8개 |
| **총계** | - | - | **~260개** |

---

### 3.2 D-1 피처 상세 (일봉 기반, ~150개)

#### 원본 지표 (~130개)

| 카테고리 | 피처 예시 | 개수 |
|----------|----------|------|
| **Seismograph 시그널** | 매집봉 강도, 변동성 수축, OBV 다이버전스, 거래량 마름 | ~15개 |
| **모멘텀** | RSI_5, RSI_14, MACD, MACD_histogram, ROC_5, ROC_10 | ~10개 |
| **이동평균** | MA_5, MA_10, MA_20, MA_50, MA_200, 골든크로스 여부 | ~10개 |
| **변동성** | ATR, ATR_percentile, 볼린저밴드 폭/위치, 켈트너 스퀴즈 | ~10개 |
| **거래량** | RVOL_20d, 거래량 추세, MFI, CMF, A/D Line | ~10개 |
| **캔들 구조** | low_to_close_ratio, 꼬리 비율, 몸통 비율, 연속 양봉 수 | ~10개 |
| **가격 레벨** | 52주 고점 대비, 20일 고저점 대비, 지지/저항 거리 | ~10개 |
| **기타** | 섹터 모멘텀, 갭 이력 등 | ~55개 |

#### 괴리 피처 (신규, ~20개)

단기-중기 지표 간 "괴리"를 별도 피처로 생성:

```python
rsi_5_14_div = RSI_5 - RSI_14
macd_signal_div = MACD - Signal_Line
ma_5_20_div = (Close - MA_5) / MA_5 - (Close - MA_20) / MA_20
# ... 등
```

**설계 근거**: 
- RSI_14가 40인데 RSI_5가 70이면 → "단기 과열 + 중기 여력"
- 이 괴리 자체가 진입 타이밍 시그널이 될 수 있다는 가설

---

### 3.3 M-n 피처 상세 (분봉 기반, ~100개)

#### T0 (급등 시작점) 정의

> **설계 원칙**: T0는 **Price 기반으로만 정의**  
> (거래량 기반 지표는 피처로 보존하여 "RVOL 상승 but 가격 미변동" 패턴 분석 가능)

**병렬 실험 진행 중**:

| 방식 | 정의 | 장점 | 단점 |
|------|------|------|------|
| **Threshold T0** | 전일 종가 대비 +6% 최초 돌파 시점 | 단순, 일관성 | 후행 (급등 중반에 T0 찍힘) |
| **Acceleration T0** | 가격 가속도 > 0.002 첫 발생 시점 | 빠른 포착 | threshold 튜닝 필요 |

**Control 종목의 T0**: 
- +6% 돌파 또는 가속 발생 시점
- 없으면 장중 최고가 도달 시점 (fallback)

#### 분석 윈도우

```
T0 - 15분  
T0 - 30분  
T0 - 60분  
T0 - 120분  
```

각 윈도우에서 동일한 피처셋 계산 → 윈도우 간 변화율도 피처화

#### M-n 피처 구성

```
핵심 20개 지표 × 4개 윈도우 = 80개
+ 윈도우간 변화율 = 20개
= ~100개
```

| 피처 | 설명 |
|------|------|
| `volume_zscore_max` | 윈도우 내 거래량 z-score 최대값 |
| `volume_acceleration` | 거래량 가속 패턴 (후반 vs 초반) |
| `rvol_spike_count` | RVOL ≥ 1.5x 분봉 개수 |
| `price_momentum` | 윈도우 내 가격 변화율 |
| `first_anomaly_timing` | 첫 이상 신호 발생 시점 (T0 - 몇 분) |
| `rsi_5_delta_15m_60m` | T0-15m의 RSI와 T0-60m의 RSI 차이 |

---

### 3.4 프리마켓 피처 (5개)

| 피처 | 설명 |
|------|------|
| `premarket_rvol` | 프리마켓 거래량 / 전일 평균 |
| `premarket_range` | (고점 - 저점) / 시가 |
| `premarket_close_location` | 종가가 프리마켓 범위의 상대 위치 |
| `gap_pct` | 전일 종가 대비 프리마켓 종가 갭 |
| `premarket_volume_profile` | 초반 vs 후반 거래량 비율 |

**설계 근거**: 프리마켓 RVOL > 10x면 정규장 급등 확률 높음 (실전 트레이더 경험)

### 3.5 메타 피처 (3개)

| 피처 | 설명 | 상태 |
|------|------|------|
| `market_regime` | BULL / NORMAL / BEAR | 차후 구현 |
| `day_of_week` | 0 ~ 4 | 구현 완료 |
| `time_since_market_open` | 분 단위 | 구현 완료 |

---

## 4. 설계 결정 사항

### 4.1 다중공선성 처리

| 항목 | 초기 제안 | 최종 결정 |
|------|----------|----------|
| 상관계수 0.9+ 피처 제거 | ✅ 적용 예정 | ❌ **삭제** |
| 괴리 피처 추가 | - | ✅ **채택** |

**결정 근거**:
- RSI_5와 RSI_14는 상관계수 0.95+지만, 괴리가 발생하는 순간이 진입 타이밍
- 원본 제거 시 이 "괴리 알파" 손실

### 4.2 피처 사전 선택

| 항목 | 초기 제안 | 최종 결정 |
|------|----------|----------|
| SelectKBest 30개 선택 후 학습 | ✅ 적용 예정 | ❌ **삭제** |
| XGBoost 내장 정규화 의존 | - | ✅ **채택** |

**결정 근거**:
- 급등 신호는 비선형 조합: `RSI < 30 AND RVOL > 5x AND ATR_percentile < 20%`
- 단일 피처 기준 mutual_info가 낮아도 조합하면 알파
- 사전 필터링 시 이런 조합 손실 우려

### 4.3 분봉 지표 수

| 항목 | 초기 제안 | 최종 결정 |
|------|----------|----------|
| 130개 전체 계산 | ✅ 적용 예정 | ❌ **노이즈 우려** |
| 핵심 20개 × 4윈도우 | - | ✅ **채택** |

**결정 근거**:
- 분봉 데이터는 일봉 대비 노이즈 비율 높음
- 실전 트레이더가 실제로 보는 지표 위주로 선별

---

## 5. 모델링 계획

### 5.1 기본 구조

```python
# 입력
X = df[feature_columns]  # ~260개 피처
y = df['is_daygainer']   # 1 = Daygainer, 0 = Control

# 모델
model = XGBClassifier(
    n_estimators=500,
    max_depth=6,
    learning_rate=0.05,
    reg_alpha=0.1,      # L1
    reg_lambda=1.0,     # L2
    subsample=0.8,
    colsample_bytree=0.8,
    early_stopping_rounds=50,
    scale_pos_weight=4  # 클래스 불균형 대응 (1:4 비율)
)

# 검증
TimeSeriesSplit(n_splits=5)
```

### 5.2 학습/테스트 분할

| 구분 | 기간 | 용도 |
|------|------|------|
| 학습 | 2021 ~ 2024 | 모델 학습 + 교차검증 |
| 테스트 | 2025 | Hold-out (Out-of-Sample) |

### 5.3 평가 지표

| 지표 | 목표 | 우선순위 |
|------|------|----------|
| **Recall** | > 70% | **1순위** |
| Precision@20 | > 30% | 2순위 |
| Lead Time | D-1 이상 | 3순위 |

### 5.4 해석 및 룰 추출

```
1. SHAP 분석으로 피처 중요도 도출
2. 상위 K개 피처의 threshold 분석
3. Decision Tree 근사로 해석 가능한 룰 추출
4. 룰을 Scanner Filter로 변환
```

---

## 6. 시장 레짐 고려사항

### 6.1 데이터 분포 특성

| 연도 | 시장 상황 | 특징 |
|------|----------|------|
| 2021 | 밈스탁 광풍 | 극단적 급등 빈발, 패턴 비정상적 |
| 2022 | 약세장 | 급등 감소 |
| 2023-2024 | 정상화 | 안정적 패턴 |

### 6.2 현재 계획

- **차후 구현**: `market_regime` 피처 추가 (BULL / NORMAL / BEAR)
- **대안 고려 중**: 레짐별 별도 모델 학습

---

## 7. 주요 설계 가정

1. **대조군 설계**: RVOL 스파이크가 있었던 종목만 대조군에 포함 → 생존자 편향 완화
2. **T0 정의**: Price 기반만 사용 → RVOL 등 거래량 지표는 피처로 보존
3. **괴리 피처**: 상호 상관된 지표의 차이가 타이밍 알파를 제공한다는 가설
4. **피처 선택**: 사전 필터링 없이 모델 정규화에 의존
5. **Recall 우선**: False Positive보다 False Negative가 더 치명적이라는 도메인 가정

---

## 8. 참조 문서

| 문서 | 설명 |
|------|------|
| `_overview.md` | 전체 백테스트 모듈 계획서 |
| `_detection.md` | Pre-Surge Detection 연구 과제 상세 |
| `002-01_feature_exploration.md` | 전체 피처 카탈로그 (130+ 피처 정의) |
| `002-02_phase_e_debate.md` | Quant vs Trader 토론 로그 (설계 결정 근거) |
| `001-04_m_n_features_plan.md` | D-1/M-n 피처 파이프라인 구현 계획 |

---

## 9. 피드백 요청

위 설계에 대해 ML 관점에서 자유롭게 검토해 주시기 바랍니다.

- 명백한 설계 오류
- 놓친 위험 요소
- 개선 가능한 접근법
- 우선적으로 검증해야 할 가정

어떤 형태의 피드백이든 환영합니다.

---

**문서 이력**
| 버전 | 일자 | 변경 내용 |
|------|------|----------|
| 1.0 | 2026-01-15 | 초안 - 질문 형식 |
| 2.0 | 2026-01-15 | 전면 개정 - 현재 설계 총괄 설명, 질문 제거 |
