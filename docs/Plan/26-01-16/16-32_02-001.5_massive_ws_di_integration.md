# [02-001.5] MassiveWebSocketClient DI 통합 구현 계획서

> **작성일**: 2026-01-16 16:32 | **예상**: 1h

---

## 1. 목표 (PRD 구조)

### 1.1 배경 (Problem)
- `MassiveWebSocketClient`가 DI Container 외부에서 수동 인스턴스화됨 (`backend/startup/realtime.py` Line 194)
- 다른 Realtime Layer 컴포넌트(`TickBroadcaster`, `SubscriptionManager`)가 `massive_ws`에 의존하지만, Container에서 가져올 수 없음
- 테스트 시 Mock 주입 불가

### 1.2 목표 (Goal)
- `MassiveWebSocketClient`를 `container.py`에 등록
- `TickBroadcaster`, `SubscriptionManager` 등 의존 컴포넌트가 Container에서 주입받을 수 있게 함

### 1.3 User Stories
- 개발자로서, `container.massive_ws()`로 WebSocket 클라이언트를 가져와 일관된 방식으로 사용하고 싶다
- 테스터로서, Mock WebSocket 클라이언트를 주입하여 네트워크 없이 테스트하고 싶다

### 1.4 Functional Requirements
1. `container.massive_ws()` 호출 시 MassiveWebSocketClient 인스턴스 반환
2. `api_key`는 환경변수(`MASSIVE_API_KEY`)에서 자동 로드
3. 서버 시작 전에도 Container에서 접근 가능 (지연 초기화)

### 1.5 Non-Goals (범위 제외)

#### 🚫 Out of Scope (영구 제외)
- ❌ WebSocket 연결 로직 변경 — 기존 로직 안정적

#### ⏳ Deferred (후속 작업으로 분리)
- ⏳ `backend/startup/realtime.py` 수정 → **[02-004]에서 해결**
- ⏳ 기존 서버 lifespan 코드 변경 → **[02-004]에서 해결**

---

## 2. 레이어 체크

- [x] 레이어 규칙 위반 없음 (`container.py` → `backend.data` 하위 계층 참조)
- [x] 순환 의존성 없음
- [x] DI Container 등록 필요: **예**

---

## 3. 변경 파일

| 파일 | 유형 | 예상 라인 |
|------|-----|----------|
| `backend/container.py` | 수정 | +25줄 |

---

## 4. 기존 솔루션 검색 결과

| 솔루션 | 출처 | 채택 여부 | 사유 |
|--------|------|----------|------|
| `dependency-injector` Singleton | 기존 container.py | ✅ 채택 | 프로젝트 표준 |
| 지연 import 패턴 | 기존 container.py | ✅ 채택 | 순환 참조 방지 |
| `Object(None)` 패턴 | container.py `ws_manager` | ❌ 미채택 | `massive_ws`는 내부 생성 가능 |

---

## 5. 의존성 분석

| 항목 | 값 |
|------|---|
| 생성자 파라미터 | `api_key: Optional[str]`, `delayed: bool`, `reconnect_interval: int` |
| 환경변수 | `MASSIVE_API_KEY` (api_key=None일 때 사용) |
| 외부 의존성 | `websockets` 라이브러리 |
| 현재 생성 위치 | `backend/startup/realtime.py:194` |

### 의존하는 컴포넌트 (하류)
| 컴포넌트 | 의존 방식 |
|----------|-----------|
| `TickBroadcaster` | 생성자 필수 인자 |
| `SubscriptionManager` | Optional, `set_massive_ws()` 호출 |

---

## 6. Tasks (2레벨 분해)

- [x] 1.0 container.py에 MassiveWebSocketClient Provider 추가
  - [x] 1.1 `_create_massive_ws()` 팩토리 함수 추가
  - [x] 1.2 `massive_ws` Singleton Provider 선언
  - [x] 1.3 config에서 `delayed`, `reconnect_interval` 읽기 (선택)
- [x] 2.0 검증
  - [x] 2.1 `ruff check backend/container.py` 통과
  - [x] 2.2 Container 수동 테스트

---

## 7. 검증

- [ ] `ruff check backend/container.py` 통과
- [ ] Container 수동 테스트:
  ```bash
  # 환경변수 설정 필요
  python -c "from backend.container import container; print(container.massive_ws())"
  ```

---

## 8. 롤백 계획

`container.py`의 `massive_ws` 섹션 삭제 → 기존 `realtime.py`에서 수동 생성 유지

---

## ⚠️ 주의사항

1. **`MASSIVE_API_KEY` 필수**: 환경변수 미설정 시 `ValueError` 발생
2. **`websockets` 라이브러리 필수**: 미설치 시 `ImportError` 발생
3. **02-002 선행 의존성**: 이 작업 완료 후 02-002 `TickBroadcaster` 등록이 더 깔끔해짐

---

## 9. 다음 단계

이 작업 완료 후:
1. **02-002 업데이트**: `massive_ws = providers.Object(None)` → `massive_ws` Singleton 참조로 변경
2. **realtime.py 통합** (별도 작업): Container에서 `massive_ws` 가져오도록 수정

---

## ✅ 승인 대기

> **다음**: 승인 후 `/IMP-execution`
