# 03-004 Score V3.2 개선 계획

> **작성일**: 2026-01-06  
> **상태**: ✅ Phase 1+2+3 완료  
> **참고**: `docs/strategy/Score_v3_Critics.md`

---

## 1. 현재 V3.1 문제점 요약

| # | 문제 | 위험도 | 영향 |
|---|------|--------|------|
| 1 | **OBV 변화율의 수학적 불안정** | 🔴 | 35% 가중치 신호가 왜곡될 수 있음 |
| 2 | **신호 간 중복 (TR/AB/VD)** | 🟡 | 정보 1개를 2~3번 세는 효과 |
| 3 | **Z→Sigmoid 레짐 취약** | 🟡 | 시장 환경 변화 시 의미 변질 |
| 4 | **곱셈 부스트 1.30x** | 🟡 | 점수 100 초과 시 스케일 붕괴 |
| 5 | **Support 이탈 = 0점** | 🟡 | 불연속 규칙으로 랭킹 불안정 |
| 6 | **고정 가중치** | 🟢 | 레짐별 유연성 부족 |
| 7 | **"폭발 직전" 해석 과잉** | 🟡 | 거짓 양성 (죽은 압축) 증가 |

---

## 2. V3.2 개선 목표

> **핵심 원칙**: 최소 변경, 최대 안정화

### 즉시 구현 (Phase 1) ✅
- [x] 곱셈 부스트 → 가산 보너스로 변경
- [x] 점수 0~100 클리핑 적용
- [x] Support 이탈 불연속 규칙 → 연속 페널티

### 중기 구현 (Phase 2) ✅
- [x] OBV Divergence → Absorption 방식으로 재정의
- [x] AB에서 "조용한 날" → "방향성 있는 조용함"으로 변경

### 장기 검토 (Phase 3) ✅
- [x] 정규화를 분위수(percentile_rank) 기반으로 안정화
- [x] RedundancyPenalty 도입 (압축만 있고 흡수 없는 경우 감점)

### 추가 검토 (Phase 4)
- [ ] Activation Trigger 분리 (Ignition Score와 통합 검토)

---

## 3. Phase 1 상세 구현 계획

### 3.1 곱셈 부스트 → 가산 보너스

**현재 (V3.1)**:
```python
Final = Base × 1.30  # 최대 130점 가능
```

**변경 (V3.2)**:
```python
# min(모든 신호) 기준 가산 보너스
harmony_bonus = B * max(0, min_intensity - 0.6)
Final = clip(Base + harmony_bonus, 0, 100)
```

**설정값**:
```python
class SignalModifierConfig:
    harmony_bonus_scale: float = 20.0  # B: 최대 약 8점 추가
    bonus_threshold: float = 0.6
```

---

### 3.2 점수 0~100 클리핑

**변경 파일**: `seismograph.py` → `calculate_watchlist_score_v3()`

```python
final_score = min(100.0, max(0.0, base_score + harmony_bonus))
```

---

### 3.3 Support 이탈 연속 페널티

**현재 (V3.1)**:
```python
if close < support:
    return 0.0  # 불연속 드랍
```

**변경 (V3.2)**:
```python
support_dist = (close - support) / atr
support_penalty = 1.0 / (1.0 + exp(-k * support_dist))  # sigmoid
vd_final = vd_base * support_penalty
```

**설정값**:
```python
class SupportConfig:
    penalty_steepness: float = 3.0  # k 값
```

---

## 4. Phase 2 상세 구현 계획

### 4.1 OBV Divergence → Absorption

**현재**: OBV 변화율 Z-score (불안정)

**변경**: Signed Volume vs Price Reaction
```python
# 최근 N일 Signed Volume, Price Reaction 계산
sv = sum(sign(returns) * volume for each day in window)
pr = sum(abs(returns) for each day in window)

# 정규화
sv_norm = sv / median_volume
pr_norm = pr / median_pr

# Absorption 신호 (거래량 많은데 가격 반응 작으면 높음)
absorption = sigmoid(z_robust(sv_norm) - z_robust(pr_norm))
```

---

### 4.2 AB "조용한 날" → "방향성 있는 조용함"

**현재**: 변동 2% 이하인 날 비율 (TR과 중복)

**변경**: 조용한 날 중 상단 마감 비율
```python
quiet_days = [d for d in data if abs_change < 0.02]
upper_close_ratio = sum(1 for d in quiet_days 
                        if d.close > (d.high + d.low) / 2) / len(quiet_days)
```

---

## 5. 검증 계획

### 자동화 테스트
- [ ] 구문 검사 (py_compile)
- [ ] 단위 테스트 (각 신호 함수)

### 수동 검증
- [ ] GUI에서 점수 분포 확인 (0~100 범위)
- [ ] 상위 10개 종목 매뉴얼 리뷰

### 백테스트 (장기)
- [ ] 상위 스코어 종목의 후행 수익률 분포
- [ ] 거짓 양성(죽은 압축) 비율 측정

---

## 6. 우선순위 및 일정

| Phase | 작업 | 예상 시간 | 우선순위 |
|-------|------|----------|----------|
| 1 | 가산 보너스 + 클리핑 | 30분 | 🔴 |
| 1 | Support 연속 페널티 | 1시간 | 🟡 |
| 2 | OBV → Absorption | 2시간 | 🟡 |
| 2 | AB 방향성 수정 | 1시간 | 🟢 |
| 3 | 분위수 정규화 | 3시간 | 🟢 |
| 3 | RedundancyPenalty | 2시간 | 🟢 |

---

## 7. 의사결정 필요 사항

> [!IMPORTANT]
> 아래 사항에 대해 사용자 확인 필요

1. **Phase 1만 우선 구현할지, 전체 V3.2를 한번에 진행할지?** : Phase 1만 우선 구현
2. **가산 보너스 스케일 (B=20.0)이 적절한지?** : B=20.0 유지
3. **Activation Trigger를 Ignition Score와 통합할지, 별도 유지할지?** : ignition score와 비교분석 후 문서 생성
